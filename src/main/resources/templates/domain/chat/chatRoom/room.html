<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>궁금하면 채팅방</title>
</head>
<body>
    <nav>
    <a href="make">채팅방 생성</a>
    <a href="list">채팅방 목록</a>
    </nav>
    <a onclick="return false;" href="https://www.naver.com">https://www.naver.com</a>
    <script th:inline="javascript">
        const roomId=/*[[${roomId]]*/0;
    </script>
    <script>
        function submitWriteForm(form) {
            form.writerName.value = form.writerName.value.trim();
            if (form.writerName.value.length === 0) {
                alert('작성자 명을 입력해주세요.');
                form.writerName.focus();
                return;
            }

            form.content.value = form.content.value.trim();

            if (form.content.value.length === 0) {
                alert('내용을 입력해주세요');
                form.content.focus();
                return;
            }

            const action = `/chat/room/${roomId}/write`;

            fetch(
                action,
                {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        writerName: form.writerName.value,
                        content: form.content.value,
                    }),
                }
            ).then(
                response => response.json()
            ).then(
                json =>{
                    if(json.msg) alert(json.msg);
                    document.write(json.data.chatMessageId+'번 메세지가 생성됨');
                }
            ).catch(error => alert(error));

            form.content.value='';
            form.content.focus();
        }

        document.querySelector('form').addEventListener('submit', function (event) {
            event.preventDefault();
            submitWriteForm(this);
        });

    </script>

    <form onsubmit="submitWriteForm(this); return false;" th:action="|/chat/room/${roomId}/write|" method="post">
        <input type="text" name="writerName" placeholder="작성자 명">
        <input type="text" name="content" placeholder="내용">
        <input type="submit" value="작성">
    </form>
    <div>
      <ul>
          <li th:each="chatMessage : ${room.chatMessages}">
              <span th:text="${chatMessage.writerName}"></span>
              :
              (<span th:text="${chatMessage.id}"></span>)
              <span th:text="${chatMessage.content}"></span>
          </li>
      </ul>
  </div>
</body>
</html>